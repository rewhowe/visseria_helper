function studlyCase(e){return e.split(/ |_/).map(e=>e[0].toUpperCase()+e.slice(1)).join("")}function snakeCase(e){return e.replace(" ","_").toLowerCase()}function int(e){return parseInt(e)||0}$(function(){if(window.matchMedia("only screen and (min-width: 640px)").matches)return;const e=$(".js-up-button"),t=$(".js-down-button");$(document).on("focus",'input[type="number"]',function(){let a=this.getBoundingClientRect();e.removeClass("hidden").css({top:a.y+window.pageYOffset+"px",left:a.right+window.pageXOffset+"px"}),t.removeClass("hidden").css({top:a.y+window.pageYOffset+"px",left:a.left-t.outerWidth()+window.pageXOffset+"px"})}).on("focusout",'input[type="number"]',function(){e.addClass("hidden"),t.addClass("hidden")}),e.on("mousedown",function(e){const t=$('input[type="number"]:focus');t.val(int(t.val())+1).trigger("change"),e.preventDefault()}),t.on("mousedown",function(e){const t=$('input[type="number"]:focus');t.val(int(t.val())-1).trigger("change"),e.preventDefault()}),$(document).on("change",'input[type="number"]',function(){let e=int($(this).val());this.max&&(e=Math.min(this.max,e)),this.min&&(e=Math.max(this.min,e)),$(this).val(e)})});const Select={KEY_DELIMITER:".",makeKey:function(e,t){return e+Select.KEY_DELIMITER+t},makeGroupedSelect:function(e,t,a=!1){const s=$('<select class="'+t+'">');s.append("<option selected"+(a?" disabled":"")+">-</option>");for(let t in e){$optGroup=$('<optgroup label="'+t+'">');for(let a in e[t]){const s=t+Select.KEY_DELIMITER+a,r=$('<option value="'+s+'">'+e[t][a]+"</option>");$optGroup.append(r)}s.append($optGroup)}return s},makeSelect:function(e,t,a=!1){const s=$('<select class="'+t+'">');s.append("<option selected"+(a?" disabled":"")+">-</option>");for(let t in e)s.append($('<option value="'+t+'">'+t+"</option>"));return s}},Gear={GEAR:{"Basic Gear":{"Angel Feather":{cost:3,dmg:0,hp:1,spec:1,spec_type:"Soul"},"Ring Of Remnai":{cost:3,dmg:0,hp:1,spec:1,spec_type:"Intelligence"},"Badge Of Heroism":{cost:3,dmg:1,hp:0,spec:1,spec_type:"Courage"},"Blank Totem":{cost:3,dmg:0,hp:1,spec:1,spec_type:"Aura"},"Loaded Die":{cost:3,dmg:1,hp:0,spec:1,spec_type:"Luck"}},"Intermediate Gear":{"Exxo Armor":{cost:5,dmg:0,hp:3,spec:2,spec_type:"Soul"},"Trinity Staff":{cost:5,dmg:1,hp:2,spec:2,spec_type:"Intelligence"},"Darkling Sword":{cost:5,dmg:3,hp:0,spec:2,spec_type:"Courage"},"Illumination Pendant":{cost:5,dmg:0,hp:3,spec:2,spec_type:"Aura"},"Broken Dagger":{cost:5,dmg:2,hp:1,spec:2,spec_type:"Luck"}},"Standard Gear":{Thirstfire:{cost:5,dmg:2,hp:0,effect:"Enemies attacked by the equipped User are debuffed with Bleed"},"Mugger Dagger":{cost:5,dmg:2,hp:0,effect:"Equipped User gains 1G for every successful attack on an Enemy if Success roll"},"Robbit's Foot":{cost:5,dmg:1,hp:1,effect:"Equipped User gains +2 Success roll"},"Devil Charm":{cost:5,dmg:3,hp:3,effect:"Equipped User gains -2 Success roll"},"Bravery Charm":{cost:5,dmg:2,hp:1,effect:"Equipped User gains +1 Decisive roll in battle involving User"},"Artifact Coin":{cost:5,dmg:2,hp:2,effect:"Item is treated as 5G"},"Absorbing Spirit":{cost:5,dmg:2,hp:2,effect:"Equipped User's Ultimate recharge rate is 2"},"Regenerating Armour":{cost:5,dmg:0,hp:3,effect:"Any DMG the equipped User receives from any source is reduced by 1 DMG"},"The Murmur":{cost:5,dmg:5,hp:0,effect:"While equipped with The Murmur: equipped User is debuffed with Silence",onEquip:function(e){e.addDebuff("silence")}}},"Legendary Gear":{"Wilhelm's Gauntlet":{cost:15,dmg:0,hp:5,limit_class:"Guardian",effect:"When the equipped User is attacked: deal DMG equal to the equipped User's DMG to the attacking Enemy. Can only be equipped by Guardians",spec:3,spec_type:"Soul"},"Solomon's Cipher":{cost:15,dmg:2,hp:3,limit_class:"Spellweaver",effect:"The equipped User can attack and use abilities once each before becoming inactive. Can only be equipped by Spellweavers",spec:3,spec_type:"Intelligence"},"Zatyr's Saber":{cost:15,dmg:5,hp:0,limit_class:"Slayer",effect:"When the equipped User attacks: equipped User recovers (Room Lvl) HP. Can only be equipped by Slayers",spec:3,spec_type:"Courage"},"Magus' Cloak":{cost:15,dmg:1,hp:4,limit_class:"Enchanter",effect:"Remove all debuffs from the equipped User. Equipped User is immune to debuffs. Can only be equipped by Enchanters",spec:3,spec_type:"Aura",onEquip:function(e){for(let t of["blind","bleed","fear","silence","curse","undead","sleep"])e.removeDebuff(t)}},"Weeper's Satchel":{cost:15,dmg:3,hp:2,limit_class:"Trickster",effect:"When this item is acquired: acquire 1 Item and +XG equal to D10 roll. The equipped User gains +2 Success roll. Can only be equipped by Tricksters",spec:3,spec_type:"Luck"}}},getGearData:function(e){e=e.split(Select.KEY_DELIMITER);const t=Gear.GEAR[e[0]];if(!t)return;const a=t[e[1]];return a.category=e[0],a.name=e[1],a},getGearKey:function(e){return Select.makeKey(e.category,e.name)}};Gear.$GEAR_SELECT=function(){const e={};for(let t in Gear.GEAR){e[t]={};for(let a in Gear.GEAR[t]){const s=Gear.GEAR[t][a],r=[s.dmg||0,s.hp||0,s.spec?s.spec+" "+s.spec_type:0];e[t][a]=a+" ("+r.join("/")+")"+(s.limit_class?" - "+s.limit_class+" only":"")}}return Select.makeGroupedSelect(e,"js-gear-select")}();const Classes={CLASSES:{Guardian:{spec_type:"Soul",characters:{"Albatross Grand":{title:"The Armoured Angel",dmg:2,hp:18,abilities:{passive:{name:"Divine Intervention",effect:"Any DMG Albatross Grand receives from Enemy attacks is reduced by Room Lvl (#room).\nWhen an ally User is attacked: Albatross Grand can be designated as the attack target instead."},active:{name:"Disarm",effect:"Target 1 Enemy: deal Soul Lvl (#spec) to the targeted Enemy.\nSuccess roll: the targeted Enemy becomes inactive."},ultimate:{name:"Aegis of Grandeur",effect:"Any DMG Albatross Grand and ally Users receive from each Enemy's next attack is reduced by Soul Lvl (#spec) DMG.",recharge:8}}},"T4O MKII":{title:"The Soul in the Shell",dmg:3,hp:17,abilities:{passive:{name:"Welded Will",effect:"T4O MKII cannot be debuffed with Bleed or Fear. T4O MKII gains Soul Lvl (#spec) Max HP."},active:{name:"Soul Cannon",effect:"Declare X less than or equal to T4O MKII's current HP. Target 1 Enemy: deal X + Room Lvl (#room) to targeted Enemy. T4O MKII loses X HP."},ultimate:{name:"Undying Spirit",effect:"T4O MKII is restored to Max HP. All debuffs on T4O MKII are removed.",recharge:7}}},Lilith:{title:"The Bad Blood",dmg:1,hp:16,abilities:{passive:{name:"Blood Drain",effect:"Any DMG from Enemies debuffed with Bleed Lilith or ally Users receive is reduced by Room Lvl (#room)."},active:{name:"Red Terror",effect:"Target 1 Enemy: deal Soul Lvl (#spec) to the targeted Enemy. The targeted Enemy becomes debuffed with Bleed. Lilith restores Room Lvl (#room) HP. If the targeted Enemy is debuffed with Bleed, remove the debuff: Lilith restores Room Lvl (#room) + Soul Lvl (#spec) HP instead."},ultimate:{name:"Blood Moon",effect:"All Enemies are now debuffed with Bleed.",recharge:8}}}}},Spellweaver:{spec_type:"Intelligence",characters:{"Harmony Marx":{title:"The Sorcerer Songstress",dmg:3,hp:14,abilities:{passive:{name:"Forte",effect:"Harmony Marx gains + Intelligence Lvl (#spec) Success roll when using abilities."},active:{name:"Song of Silence",effect:"Target 1 Enemy: deal 2 x Intelligence Lvl (#spec) to the targeted Enemy.\nSuccess roll: the targeted Enemy becomes debuffed with Silence."},ultimate:{name:"Pentatonic Harmony",effect:"Each User deals their respective DMG to an Enemy.",recharge:10}}},Ariadne:{title:"The Blind Prophet",dmg:1,hp:11,abilities:{passive:{name:"Dimensional Decision",effect:"Before entering a Room when a Room Tile is revealed: reveal the top 2 Room Cards of that revealed Room Tile type from the respective deck and choose 1. The revealed Room Tile is now that chosen Room Card. Shuffle the other Room Cards revealed this way back into their respective decks."},active:{name:"Darkness Falls",effect:"Target 1 Enemy: deal 2 x Intelligence Lvl (#spec) to the targeted Enemy.\nSuccess roll: the targeted Enemy becomes debuffed with Blind."},ultimate:{name:"Foreseer's Favour",effect:"Once per Room, reveal and reset 1 undiscovered Room Tile or target 1 discovered Room Tile. Ariadne gains the following effects based on the revealed or targeted Room Tile type:\n・Mob Room/Mini Boss Room: Ariadne gains + Intelligence Lvl (#spec) DMG for the Room\n・Trap Room: Ariadne gains + Intelligence Lvl (#spec) Success roll for the Room\n・Treasure Room: Ariadne and ally Users restore Intelligence Lvl (#spec) HP",recharge:5}}},Psykoshka:{title:"The Lost Familiar",dmg:2,hp:13,abilities:{passive:{name:"Equilibrium",effect:"Psykoshka gains + Intelligence Lvl (#spec) Soul Lvl, Courage Lvl, Aura Lvl and Luck Lvl."},active:{name:"Copycat",effect:"Psykoshka can use the active ability of 1 ally User."},ultimate:{name:"Remnai's Retribution",effect:"Each User chooses either: restore their respective Spec Lvl HP or deal their respective Spec Lvl to an Enemy.",recharge:8}}}}},Slayer:{spec_type:"Courage",characters:{"Grimwulf Kaiser":{title:"The Howling Death",dmg:9,hp:9,abilities:{passive:{name:"Battle Howl",effect:"The party gains + Courage Lvl (#spec) Decisive roll."},active:{name:"Duality",effect:"Target 2 Enemies: deal half of the sum of DMG (#dmg) + Courage Lvl (#spec) (rounded up) to the targeted Enemies."},ultimate:{name:"Grim Execution",effect:"Deal DMG (#dmg) + Number of Room Lvl Enemies in the discard pile (Max. 10) divided to any number of Enemies. Shuffle all Room Lvl Enemies back into their respective decks.",recharge:5}}},Jackal:{title:"The Soundslinger",dmg:7,hp:7,abilities:{passive:{name:"Sonic Snipe",effect:"When entering a Mob Room/Boss Room before Decisive roll, Success roll: Deal DMG (#dmg) + Courage Lvl (#spec) to 1 Enemy."},active:{name:"Echo",effect:"Target 1 Enemy: deal Courage Lvl (#spec) to targeted Enemy and Room Lvl (#room) to all other Enemies."},ultimate:{name:"EQ",effect:"Target 1 Enemy: deal Room Lvl (#room) + Courage Lvl (#spec) to targeted Enemy. Jackal restores Room Lvl (#room) + Courage Lvl (#spec) HP. Remove all debuffs from Jackal and debuff the targeted Enemy with the debuffs removed this way.",recharge:7}}},Vulcana:{title:"The Pyroxian Flame",dmg:8,hp:8,abilities:{passive:{name:"Overheat",effect:"When Vulcana defeats an Enemy, Success roll: deal any overkill DMG to another Enemy."},active:{name:"Spontaneous Combustion",effect:"Randomly choose a target between Vulcana and each Enemy.\nIf Vulcana is targeted: Vulcana restores Courage Lvl (#spec) HP.\n If an Enemy is targeted: deal DMG (#dmg) to that enemy."},ultimate:{name:"Reckless Inferno",effect:"Vulcana deals DMG (#dmg) + Courage Lvl (#spec) to 1 Enemy.\nVulcana gains + Courage Lvl (#spec) Success roll during the Round this ability is used.\nVulcana loses Courage Lvl (#spec) HP.",recharge:6}}}}},Enchanter:{spec_type:"Aura",characters:{"Misteyes Snow":{title:"The White Fox",dmg:3,hp:7,abilities:{passive:{name:"Empath's Crystal",effect:"When Misteyes Snow or an ally User restores HP, they restore an additional Room Lvl (#room) HP. If a User restored HP with this ability while at Aura Lvl (#spec) HP or less: they restore 2 x Room Lvl (#room) instead."},active:{name:"Whiteout",effect:"Remove all debuffs on up to Aura Lvl (#spec) ally User(s). If this ability removes a debuff: deal DMG (#dmg) to 1 Enemy."},ultimate:{name:"Spirit Snowfall",effect:"Resurrect 1 Dead User.",recharge:10}}},Dexler:{title:"The Mad Alchemist",dmg:1,hp:8,abilities:{passive:{name:"Duplicate",effect:"Once per Room, when a Consumable Item would be discarded by Dexler's active ability or consumed, Success roll: gain the effects of the Consumable Item without discarding or consuming it."},active:{name:"Alchemic Warfare",effect:"Discard 1 Consumable Item. Either target 1 Enemy: deal Room Lvl (#room) + Aura Lvl (#spec) to targeted Enemy or target 1 ally User. Targeted ally User restores Room Lvl (#room) + Aura Lvl (#spec) HP."},ultimate:{name:"The Creator",effect:"Reveal Aura Lvl (#spec) cards from the top of the Item Deck: acquire Room Lvl (#room) Consumable Item(s) (if any) of the revealed Item cards and shuffle the rest back into the Item deck.",recharge:10}}},"Færie":{title:"The Fable of the Forest",dmg:0,hp:9,abilities:{passive:{name:"Blessing of the Fæ",effect:"While Færie is at Max HP: Færie and ally Users gain + 1 Success roll and + Room Lvl (#room) DMG."},active:{name:"Sacred Medicine",effect:"Target 1 User: targeted User restores Room Lvl (#room) + Aura Lvl (#spec) HP."},ultimate:{name:"Fæth",effect:"Target 1 User with Room Lvl (#room) + Aura Lvl (#spec) HP or less: the targeted User restores Max HP. All debuffs on targeted User are removed.",recharge:7}}}}},Trickster:{spec_type:"Luck",characters:{Ein:{title:"The Defier of Destiny",dmg:5,hp:10,abilities:{passive:{name:"Get Chance and Luck",effect:"Ein gains + Luck Lvl (#spec) Success roll. Whenever Ein passes a Success roll: Ein restores Room Lvl (#room) HP."},active:{name:"Tempt Fate",effect:"Target 1 Enemy, Success roll: deal DMG (#dmg) + Luck Lvl (#spec) to the targeted Enemy.\nIf Success roll fails: deal DMG (#dmg) - Luck Lvl (#spec) to targeted Enemy instead."},ultimate:{name:"Lucky Break",effect:"Success roll 3 times: deal Luck Lvl (#spec) to up to 3 Enemies. If a Success roll fails, this ability does nothing.",recharge:7}}},Zuciel:{title:"The Phantom of Sin",dmg:4,hp:13,abilities:{passive:{name:"Greed",effect:"Whenever Zuciel attacks, declare X: Zuciel deals DMG (#dmg) + (X) to the attack target. Discard (X) G. The party can buy Items with Room Lvl (#spec) less G."},active:{name:"Sloth",effect:"Zuciel restores Luck Lvl (#spec) HP."},ultimate:{name:"Wrath",effect:"Deal G (#gold) to Luck Lvl (#spec) Enemies. Discard Luck Lvl (#spec) G.",recharge:2}}},Marina:{title:"The Chronokeeper",dmg:4,hp:12,abilities:{passive:{name:"Temporal Shift",effect:"Once per Room, when any die is rolled: Marina can reroll the result."},active:{name:"Photon Pulse",effect:"Target 1 Enemy, D10 roll: deal (D10 roll) + Luck Lvl (#spec) to targeted Enemy."},ultimate:{name:"Chrono Cure",effect:"Roll the Target die Room Lvl (#room) times. Declare 1 result: declared targeted User restores Luck Lvl (#spec) HP and Ultimate Gauge is recharged by Luck Lvl (#spec).",recharge:8}}}}}},getCharacterData:function(e){e=e.split(Select.KEY_DELIMITER);const t=Classes.CLASSES[e[0]].characters[e[1]];return t.class=e[0],t.name=e[1],t.specType=Classes.CLASSES[e[0]].spec_type,t},makeCharacter:function(e,t,a=null){const s=studlyCase(t.split(Select.KEY_DELIMITER)[1]);return Classes[s]?new Classes[s](e,t,a):new Character(e,t,a)}};Classes.$CLASS_SELECT=function(){const e={};for(let t in Classes.CLASSES){e[t]={};for(let a in Classes.CLASSES[t].characters)e[t][a]=a}return Select.makeGroupedSelect(e,"js-class-select",!0)}();class Character{static get MAX_LEVEL(){return 3}static get STATUSES(){return["hp","dmg","spec","recharge"]}constructor(e,t,a=null){this.$node=e;const s=Classes.getCharacterData(t);this.class=s.class,this.name=s.name,this.specType=s.specType,this.abilities=s.abilities,this.$node.removeClass(Object.keys(Classes.CLASSES).join(" ")).addClass(this.class),this.level=0,this.globalMod={dmg:0},this.$icon=this.$node.find(".js-icon").attr("src","./public/img/"+snakeCase(this.name)+".png"),this.$title=this.$node.find(".js-title").html(s.title),this.$class=this.$node.find(".js-class-select"),this.$debuffs=this.$node.find(".js-debuff"),this.$debuffs.each((e,t)=>$(t).removeClass("checked")),this.$ultimate=this.$node.find(".js-ability-ultimate"),this.hp={current:s.hp,base:s.hp,moddedValue:s.hp,$current:this.$node.find(".js-hp-current").val(s.hp),$value:this.$node.find(".js-hp-max"),$detail:this.$node.find(".js-hp-detail"),$mod:this.$node.find(".js-hp-mod")},this.dmg={base:s.dmg,moddedValue:s.dmg,$value:this.$node.find(".js-dmg-value").val(s.dmg),$detail:this.$node.find(".js-dmg-detail"),$mod:this.$node.find(".js-dmg-mod")},this.spec={base:1,moddedValue:1,$name:this.$node.find(".js-spec-name").html(s.specType),$value:this.$node.find(".js-spec-value"),$detail:this.$node.find(".js-spec-detail"),$mod:this.$node.find(".js-spec-mod")},this.recharge={current:0,base:s.abilities.ultimate.recharge,moddedValue:s.abilities.ultimate.recharge,$current:this.$node.find(".js-recharge-current").val(0),$value:this.$node.find(".js-recharge-value"),$detail:this.$node.find(".js-recharge-detail"),$mod:this.$node.find(".js-recharge-mod")},this.gear=[],this.$gear=this.$node.find(".js-gear"),this.$gear.find(".js-gear-select").val("-"),this.$node.find(".js-gear .js-show-detail, .js-gear .js-detail, .js-item .js-show-detail, .js-item .js-detail").addClass("hidden").removeClass("pressed"),this.$node.find(".js-status-mod").val(""),a&&this.fromBundle(a),this.refresh(),this.$node.find(".js-character-detail").slideDown()}updateAbilities(){for(let e in this.abilities){const t=this.abilities[e];let a=t.effect;a=(a=(a=(a=(a=a.replace(/\n/g,"<br>")).replace(/#dmg/g,"<strong>"+this.dmg.moddedValue+"</strong>")).replace(/#spec/g,'<strong class="spec">'+this.spec.moddedValue+"</strong>")).replace(/#room/g,"<strong>"+GAME.getRoomLevel()+"</strong>")).replace(/#gold/g,"<strong>"+GAME.getGold()+"</strong>"),this.$node.find(".js-ability-"+e+" .js-ability-name").html(t.name),this.$node.find(".js-ability-"+e+" .js-detail").html(a)}}mod(e){const t=this.getStatusMod(e),a=this[e].base;this[e].moddedValue=Math.max(0,a+t),this[e].$value.html(this[e].moddedValue),this.updateStatusDetail(e,t,a),this.updateCurrentStatus(e),this.updateAbilities()}getStatusMod(e){return int(this[e].$mod.val())+this.getGearMod(e)+this.getGlobalCharacterMod(e)}getGearMod(e){const t=this.specType;return this.gear.reduce(function(a,s){return!s||"spec"===e&&s.spec_type&&s.spec_type!==t||(a+=s[e]||0),a},0)}getGlobalCharacterMod(e){return $(".js-character").toArray().reduce(function(t,a){const s=$(a).data("character");return t+(s?int(s.globalMod[e]):0)},0)}updateStatusDetail(e,t,a){if(0!==t){const s=t>0?" + ":" - ";this[e].$detail.html(a+s+Math.abs(t)),this[e].$detail.parent().addClass("character-status-modified")}else this[e].$detail.html(""),this[e].$detail.parent().removeClass("character-status-modified")}updateCurrentStatus(e){-1!==["hp","recharge"].indexOf(e)&&(this[e].current=Math.min(this[e].current,this[e].moddedValue),this[e].$current.val(this[e].current),"recharge"===e&&(this.recharge.current===this[e].moddedValue?this.$ultimate.addClass("charged"):this.$ultimate.removeClass("charged")))}changeCurrent(e){this[e].current=int(this[e].$current.val()),this.mod(e),"hp"===e&&0===this.hp.current?this.$node.addClass("dead"):this.$node.removeClass("dead")}changeGear(e,t){const a=Gear.getGearData(t),s=a&&(!a.limit_class||this.class===a.limit_class);return this.gear[e]=s?a:void 0,this.refresh(),this.updateEffect(this.gear[e],$(this.$gear[e])),s&&this.gear[e].onEquip&&this.gear[e].onEquip(this),s}changeItem(e,t){const a=Items.getItemData(t);this.updateEffect(a,e)}updateEffect(e,t){e&&e.effect?(t.find(".js-show-detail").removeClass("hidden"),t.find(".js-detail").html(e.effect)):(t.find(".js-show-detail, .js-detail").addClass("hidden"),t.find(".js-detail").html(""))}updateLevel(e){this.level=Math.min(Character.MAX_LEVEL,Math.max(0,e)),this.hp.$current.val(this.hp.base+this.getStatusMod("hp")),this.changeCurrent("hp"),this.mod("dmg")}refresh(){for(let e of Character.STATUSES)this.mod(e)}addDebuff(e){const t=this.$debuffs.filter('[data-type="'+e+'"]'),a=t.hasClass("checked");return this.canDebuff(e)&&t.addClass("checked"),a!==t.hasClass("checked")}canDebuff(e){for(let e of this.gear)if(e&&"Magus' Cloak"===e.name)return!1;return!0}removeDebuff(e){const t=this.$debuffs.filter('[data-type="'+e+'"]');return!!t.hasClass("checked")&&(t.removeClass("checked"),!0)}toBundle(){const e={debuffs:this.$debuffs.map((e,t)=>$(t).hasClass("checked")).toArray(),character_key:Select.makeKey(this.class,this.name),level:this.level,hp:{current:this.hp.current,mod:int(this.hp.$mod.val())},dmg:{mod:int(this.dmg.$mod.val())},spec:{mod:int(this.spec.$mod.val())},recharge:{current:this.recharge.current,mod:int(this.recharge.$mod.val())},gear:[],items:[]};for(let t of this.gear)t&&e.gear.push(Gear.getGearKey(t));return this.$node.find(".js-item select").each(function(t,a){const s=$(a).val();s&&e.items.push(s)}),e}fromBundle(e){this.$class.val(e.character_key),this.level=e.level;for(let t in e.gear)this.gear[t]=Gear.getGearData(e.gear[t]),$(this.$gear[t]).find(".js-gear-select").val(e.gear[t]),this.updateEffect(this.gear[t],$(this.$gear[t]),"gear");const t=this.$node.find(".js-item select");for(let a in e.items)$(t[a]).val(e.items[a]).trigger("change");for(let t of Character.STATUSES)this[t].$mod.val(int(e[t].mod)),-1!==["hp","recharge"].indexOf(t)&&(this[t].current=e[t].current);for(let t in e.debuffs)e.debuffs[t]&&$(this.$debuffs[t]).addClass("checked")}}Classes.Færie=class extends Character{mod(e){if(super.mod(e),"hp"!==e)return;const t=this.hp.current===this.hp.moddedValue?GAME.getRoomLevel():0;t!==this.globalMod.dmg&&(this.globalMod.dmg=t,$(".js-character").each(function(e,t){const a=$(t).data("character");a&&a.mod("dmg")}))}},Classes.T4OMKII=class extends Character{mod(e){super.mod(e),"spec"===e&&this.mod("hp")}getStatusMod(e){return super.getStatusMod(e)+("hp"===e?this.spec.base+this.getStatusMod("spec"):0)}canDebuff(e){return"bleed"!==e&&"fear"!==e&&super.canDebuff(e)}};const Items={ITEMS:{"Bangbang Bomb":{cost:3,effect:"Deal 3 x (Room Lvl) DMG to 1 Enemy"},"Counterfeit Coin":{cost:3,effect:"This Item is treated as 1G"},Elixir:{cost:3,effect:"Recharges the User's Ultimate Gauge to Max"},"Fortune's Fruit":{cost:3,effect:"Grant 1 User to pass a Success roll regardless of roll result"},Minimimic:{cost:3,effect:"Immediately battle a Mimic Mob"},Panacea:{cost:3,effect:"Removes all Debuffs from 1 User"},Potion:{cost:3,effect:"1 User Recovers 3 x (Room Lvl) HP"},"Resurrection Ring":{cost:15,effect:"Resurrects 1 Dead User to Max HP with no Debuffs"},"Shine Shield":{cost:3,effect:"Blocks 5 DMG"},"Smoke Bomb":{cost:3,effect:"All Users can Escape the current Room and return to the previous Room. The Escaped Room Tile is Reset"},"Sorcerer's Eye":{cost:3,effect:"Reveals all adjacent Room Tiles. Any Room not entered by the end of the turn is reset"},"Tasty Haste":{cost:3,effect:"Grants +2 Decisive roll for the Room"}},getItemData:function(e){const t=Items.ITEMS[e];if(t)return t.name=e,t}};Items.$ITEM_SELECT=Select.makeSelect(Items.ITEMS,"js-item-select");class Storage{static localStorageAvailable(){try{return!!localStorage}catch(e){return!1}}static get SAVE_DELAY(){return 5e3}static get PROMPT(){return{request:{message:"Would you like to save your data locally?",no:"No, don't!",yes:"Sure"},update:{message:"Hey, we've updated, so old data will be deleted. Sorry!<br>Do you still want to save your data locally?",no:"Nah",yes:"Yes please!"}}}constructor(e){this.$mainContent=e,this.gameData={},this.savePid={},this.$storagePrompt=$(".js-storage-prompt");const t=this;this.$storagePrompt.on("click",".js-prompt-button",function(){"yes"===$(this).data("answer")&&t.saveToStorage(),t.$storagePrompt.remove()}),$(document).on("change",this.queueSave.bind(this))}queueSave(){Storage.localStorageAvailable()&&(window.clearTimeout(this.savePid),this.savePid=window.setTimeout(this.saveToStorage.bind(this),Storage.SAVE_DELAY))}saveToStorage(){this.gameData[APP_VERSION]={key_shards:GAME.getKeyShards(),gold:GAME.getGold(),characters:[]};const e=this.gameData;this.$mainContent.find(".js-character").each(function(t,a){const s=$(a).data("character");s&&e[APP_VERSION].characters.push(s.toBundle())}),localStorage.visseria=JSON.stringify(this.gameData)}loadFromStorage(e,t,a){if(Storage.localStorageAvailable()&&localStorage.visseria)try{if(this.gameData=JSON.parse(localStorage.visseria),Object.keys(this.gameData).length>0&&!this.gameData[APP_VERSION])throw this.showPrompt("update"),"App was updated to version: "+APP_VERSION;if(t.val(this.gameData[APP_VERSION].key_shards),a.val(this.gameData[APP_VERSION].gold),this.gameData[APP_VERSION].characters)for(let t of this.gameData[APP_VERSION].characters)e(t);this.$mainContent.find(".js-character").each(function(e,t){const a=$(t).data("character");a&&a.refresh()})}catch(e){console.error("An error occurred while loading from storage:\n"+e)}else Storage.localStorageAvailable()&&this.showPrompt("request")}showPrompt(e){this.$storagePrompt.find(".js-prompt-message").html(Storage.PROMPT[e].message),this.$storagePrompt.find(".js-prompt-button.no").html(Storage.PROMPT[e].no),this.$storagePrompt.find(".js-prompt-button.yes").html(Storage.PROMPT[e].yes),this.$storagePrompt.removeClass("hidden")}}const APP_VERSION="v2",GAME={};$(function(){$(".js-version").html(APP_VERSION);const e=5,t=$(".js-character-template .js-character"),a=$(".js-key-shards"),s=$(".js-gold"),r=$(".js-main-content"),i=$(".js-add-character"),o=new Storage(r);function n(e=null){const a=t.clone();a.insertBefore(i.parent()),e&&c(a,e.character_key,e)}function c(e,t,a=null){const s=Classes.makeCharacter(e,t,a);return e.data("character",s),s}function l(){r.find(".js-character").length>=e?i.hide():i.show()}GAME.getKeyShards=(()=>int(a.val())),GAME.getRoomLevel=(()=>Math.min(3,int(a.val())+1)),GAME.getGold=(()=>int(s.val())),t.find(".js-class").append(Classes.$CLASS_SELECT.clone()),t.find(".js-gear").each((e,t)=>$(t).prepend(Gear.$GEAR_SELECT.clone().attr("data-slot",e))),t.find(".js-item").each((e,t)=>$(t).prepend(Items.$ITEM_SELECT.clone())),i.on("click",function(){n(),l()}),a.on("change",function(){const e=int($(this).val());r.find(".js-character").each(function(t,a){const s=$(a).data("character");s&&s.updateLevel(e)})}),s.on("change",function(){r.find(".js-character").each(function(e,t){const a=$(t).data("character");a&&"Zuciel"===a.name&&a.mod("dmg")})}),$(document).on("click",".js-delete-character",function(){$(this).closest(".js-character").remove(),l(),o.queueSave()}),$(document).on("change",".js-class-select",function(){c($(this).closest(".js-character"),$(this).val()).updateLevel(GAME.getKeyShards()),r.find(".js-character").each(function(e,t){const a=$(t).data("character");a&&a.refresh()})}),$(document).on("change",".js-gear-select",function(){const e=$(this).closest(".js-character").data("character");e&&(e.changeGear($(this).data("slot"),$(this).val())||$(this).val("-"))}),$(document).on("change",".js-item-select",function(){const e=$(this).closest(".js-character").data("character");e&&e.changeItem($(this).parent(),$(this).val())}),$(document).on("change",".js-status-mod",function(){const e=$(this).closest(".js-character").data("character");e&&e.mod($(this).data("status"))}),$(document).on("change",".js-hp-current, .js-recharge-current",function(){const e=$(this).closest(".js-character").data("character");e&&e.changeCurrent($(this).data("status"))});for(let e of["gear","ability","item"])$(document).on("click",".js-show-detail",function(){$(this).toggleClass("pressed"),$(this).parent().siblings(".js-detail").toggleClass("hidden")});$(document).on("click",".js-debuff",function(){const e=$(this).closest(".js-character").data("character");if(!e)return;let t=!1;(t=$(this).hasClass("checked")?e.removeDebuff($(this).data("type")):e.addDebuff($(this).data("type")))&&o.queueSave()}),o.loadFromStorage(n,a,s),0===r.find(".js-character").length&&n()});