function titleCase(e){return e.split(/ |_/).map(e=>e[0].toUpperCase()+e.slice(1)).join(" ")}function int(e){return parseInt(e)||0}$(function(){if(window.matchMedia("only screen and (min-width: 640px)").matches)return;const e=$(".js-up-button"),t=$(".js-down-button");$(document).on("focus",'input[type="number"]',function(){let a=this.getBoundingClientRect();e.removeClass("hidden").css({top:a.y+window.pageYOffset+"px",left:a.right+window.pageXOffset+"px"}),t.removeClass("hidden").css({top:a.y+window.pageYOffset+"px",left:a.left-t.outerWidth()+window.pageXOffset+"px"})}).on("focusout",'input[type="number"]',function(){e.addClass("hidden"),t.addClass("hidden")}),e.on("mousedown",function(e){const t=$('input[type="number"]:focus');t.val(int(t.val())+1).trigger("change"),e.preventDefault()}),t.on("mousedown",function(e){const t=$('input[type="number"]:focus');t.val(int(t.val())-1).trigger("change"),e.preventDefault()}),$(document).on("change",'input[type="number"]',function(){let e=int($(this).val());this.max&&(e=Math.min(this.max,e)),this.min&&(e=Math.max(this.min,e)),$(this).val(e)})});const Select={KEY_DELIMITER:".",makeKey:function(e,t){return e+Select.KEY_DELIMITER+t},makeSelect:function(e,t,a=!0){const s=$('<select class="'+t+'">');s.append("<option selected"+(a?" disabled":"")+">-</option>");for(let t in e){$optGroup=$('<optgroup label="'+titleCase(t)+'">');for(let a in e[t]){const s=t+Select.KEY_DELIMITER+a,i=$('<option value="'+s+'">'+titleCase(e[t][a])+"</option>");$optGroup.append(i)}s.append($optGroup)}return s}},Classes={CLASSES:{guardian:{spec_type:"soul",characters:{albatross_grand:{title:"The Armored Angel",dmg:2,hp:18,abilities:{passive:{name:"Feather Shield",effect:"Albatross Grand takes -1x (Soul Lvl) DMG from enemy attacks"},active:{name:"Guardian of the Gods",effect:"Albatross Grand can block 2 enemies per Round"},ultimate:{name:"Divine Intervention",effect:"Negate any DMG any 1 active ally User is dealt this turn",recharge:5}}},T4O_MKII:{title:"The Soul in the Shell",dmg:3,hp:16,abilities:{passive:{name:"Welded Will",effect:"T4O MKII cannot be debuffed with Bleed or Fear. T4O MKII gains +1x (Soul Lvl) Max HP"},active:{name:"Self Destruct",effect:"T4O MKII deals XDMG to 1 enemy and loses XHP. (X cannot be greater than T4O MKII's Max HP)"},ultimate:{name:"Recharge",effect:"T4O MKII heals to Max HP",recharge:7}}},lilith:{title:"The Bad Blood",dmg:1,hp:16,abilities:{passive:{name:"Siphon",effect:"Attacking enemies heals Lilith for +1x (Soul Lvl) HP. Attacking enemies debuffs them with Bleed"},active:{name:"Blood Drain",effect:"If an active enemy is debuffed with Bleed, remove the debuff and deal 1x (Soul Lvl) DMG to that enemy"},ultimate:{name:"Vampire's Desire",effect:"All enemies are debuffed with Bleed",recharge:6}}}}},spellweaver:{spec_type:"intelligence",characters:{harmony_marx:{title:"The Sorcerer Songstress",dmg:5,hp:14,abilities:{passive:{name:"Tempo",effect:"Harmony Marx gains +1x (Intelligence Lvl) succession roll for each successful attack on an enemy. This effect stacks but resets when Harmony Marx leaves the Room"},active:{name:"Song of Silence",effect:"Debuff 1 basic enemy with Silence til the end of the next turn if succession roll"},ultimate:{name:"Da Capo",effect:"Once per Room, gain an extra turn if succession roll",recharge:10}}},ariadne:{title:"The Blind Prophet",dmg:6,hp:11,abilities:{passive:{name:"Dimensional Decision",effect:"Once during your turn when a Room Type is revealed, draw the top 3 Rooms of that revealed Type and choose 1. It is now that chosen Room"},active:{name:"Darkness Falls",effect:"Blind 1 basic enemy til the end of the next turn if succession roll"},ultimate:{name:"Foreseer's Favour",effect:"Ariadne gains the following ability based on the current Room type:\nMob/Boss Room - Once per Room, Ariadne gains +1x (Intelligence Lvl) DMG for the Room\nTrap Room - Ariadne gains +1x (Intelligence Lvl) succession roll\nTreasure Room - Gain +1 Item if an Item is gained and/or gain +1 Note if a Note is gained",recharge:5}}},psykoshka:{title:"The Lost Familiar",dmg:4,hp:13,abilities:{passive:{name:"Symmetry",effect:"Psykoshka gains +1x (Intelligence Lvl) DMG"},active:{name:"Copycat",effect:"Once per turn, Psykoshka can use the active ability of an active User"},ultimate:{name:"Loyalty",effect:"Active ally Users gain +1x (Intelligence Lvl) Special Stat Lvl for the turn",recharge:8}}}}},slayer:{spec_type:"courage",characters:{grimwulf_kaiser:{title:"The Howling Death",dmg:5,hp:9,abilities:{passive:{name:"First Strike",effect:"Gain +1x (Courage Lvl) decisive roll"},active:{name:"Dual Wield",effect:"Deal half of DMG (rounded up) to up to 2 enemies"},ultimate:{name:"Hellhound",effect:"Grimwulf Kaiser spawns a Hellhound Token with +1x (Courage Lvl) DMG and 1 Max HP. There can only be 1 active Hellhound Token at a time",recharge:6}}},jackal:{title:"The Soundslinger",dmg:7,hp:7,abilities:{passive:{name:"Sonic Snipe",effect:"Upon discovering a Mob room before decisive roll, Jackal can immediately attack 1 enemy if succession roll"},active:{name:"Echo",effect:"Deal DMG to 1 enemy equal to the last blocked DMG by Jackal +1x (Courage Lvl)"},ultimate:{name:"Distortion",effect:"1 active enemy receives +1x (Courage Lvl) DMG from attacks for the turn",recharge:7}}},vulcana:{title:"The Pyroxian Flame",dmg:6,hp:8,abilities:{passive:{name:"Catching Fire",effect:"Any overkill damage done by Vulcana is dealt to another activ enemy"},active:{name:"Fire Dance",effect:"Vulcana gains +1x (Courage Lvl) DMG for the next attack"},ultimate:{name:"Pyreball",effect:"Vulcana deals 3+ (Courage Lvl) DMG to 1 enemy if succession roll. This ability repeats until Vulcana fails a succession roll",recharge:6}}}}},enchanter:{spec_type:"aura",characters:{misteyes_snow:{title:"The White Fox",dmg:3,hp:14,abilities:{passive:{name:"Empath",effect:"Any healing Misteyes Snow receives also heals 1 active ally User for the same amount +1x (Aura Lvl) "},active:{name:"Erasure",effect:"Once per Room, Misteyes Snow can remove all debuffs on 1x (Aura Lvl) active Users"},ultimate:{name:"Light of Life",effect:"Once per Room, If an active ally User (except Misteyes Snow) died of any source this turn, they are immediately resurrected",recharge:10}}},dexler:{title:"The Mad Alchemist",dmg:1,hp:11,abilities:{passive:{name:"Duplicate",effect:"Once per turn when a basic consumable item is used or discarded, Dexler gains 1 copy of that item if succession roll"},active:{name:"Alchemic Warfare",effect:"Dexler can discard a consumable Item to deal 5+ (Aura Lvl) DMG to an enemy or heal an active ally User for 5+ (Aura Lvl) HP"},ultimate:{name:"The Creator",effect:"Once per Room, Dexler acquires any one basic consumable",recharge:5}}},faerie:{title:"The Fable of the Forest",dmg:0,hp:13,abilities:{passive:{name:"Blessing of the Fae",effect:"During Battle, all active ally Users gain +1x (Aura Lvl) DMG for the first attack if they attack first."},active:{name:"Sacred Medicine",effect:"Heal 1 active ally User +1x (Aura Lvl) "},ultimate:{name:"Faeth",effect:"Heal 1 active ally User to Max HP. That User cannot attack or use abilities the turn this ability is used",recharge:7}}}}},trickster:{spec_type:"luck",characters:{ein:{title:"The Shadewalker",dmg:6,hp:10,abilities:{passive:{name:"Chance and Luck",effect:"Successful succession rolls grants Ein +1x (Luck Lvl) DMG. This effect can stack but resets if a succession roll fails"},active:{name:"Gamble",effect:"Active ally Users gain +1x (Luck Lvl) succession roll for the turn"},ultimate:{name:"Shadow Sneak",effect:"Upon discovering a Trap Room, it is disabled if succession roll",recharge:5}}},zuciel:{title:"The Phantom of Sin",dmg:0,hp:13,abilities:{passive:{name:"Greed",effect:"Zuciel cannot gain DMG from any Gear but gains DMG equal to the party's total G"},active:{name:"Sloth",effect:"Zuciel heals for +1x (Luck Lvl) HP"},ultimate:{name:"Wrath",effect:"If Zuciel is at full health, he can attack 1x (Luck Lvl) enemies. Zuciel's health becomes 1",recharge:1}}},marina:{title:"The Chronokeeper",dmg:5,hp:10,abilities:{passive:{name:"Choice of Chronos",effect:"Once per Room, when an Item is acquired, Marina can discard the Item and acquire a new one instead. This can be repeated 1x (Luck Lvl) times"},active:{name:"Rewrite Destiny",effect:"When a die is rolled, Marina can ignore the result and roll once more"},ultimate:{name:"Gift of the Chronokeepers",effect:"Once per Room, all other active Users' Ultimate Gauge become full",recharge:10}}}}}},getCharacter:function(e){e=e.split(Select.KEY_DELIMITER);const t=Classes.CLASSES[e[0]].characters[e[1]];return t.class=e[0],t.name=e[1],t.specType=Classes.CLASSES[e[0]].spec_type,t},getCharacterKey:function(e){return Select.makeKey(e.class,e.name)}};Classes.$CLASS_SELECT=function(){const e={};for(let t in Classes.CLASSES){e[t]={};for(let a in Classes.CLASSES[t].characters)e[t][a]=a}return Select.makeSelect(e,"js-class-select")}();const Gear={GEAR:{basic_gear:{angel_feather:{cost:3,dmg:0,hp:1,spec:1,spec_type:"soul"},ring_of_remnai:{cost:3,dmg:0,hp:1,spec:1,spec_type:"intelligence"},badge_of_heroism:{cost:3,dmg:1,hp:0,spec:1,spec_type:"courage"},blank_totem:{cost:3,dmg:0,hp:1,spec:1,spec_type:"aura"},loaded_die:{cost:3,dmg:1,hp:0,spec:1,spec_type:"luck"}},intermediate_gear:{exxo_armor:{cost:5,dmg:0,hp:3,spec:2,spec_type:"soul"},trinity_staff:{cost:5,dmg:1,hp:2,spec:2,spec_type:"intelligence"},darkling_sword:{cost:5,dmg:3,hp:0,spec:2,spec_type:"courage"},illumination_pendant:{cost:5,dmg:0,hp:3,spec:2,spec_type:"aura"},broken_dagger:{cost:5,dmg:2,hp:1,spec:2,spec_type:"luck"}},standard_gear:{thirstfire:{cost:5,effect:"Enemies the equipped User attacks are debuffed with Bleed"},mugger_dagger:{cost:5,effect:"Equipped User gains +1G every successful attack on an Enemy if succession roll"},bones:{cost:5,dmg:1,hp:5,effect:"Equipped User is debuffed with Undead"},lucky_charm:{cost:5,dmg:1,hp:1,effect:"Equipped User gains +2 succession roll"},devil_charm:{cost:5,dmg:3,hp:3,effect:"Equipped User gains -1 succession roll"},courage_charm:{cost:5,dmg:2,hp:1,effect:"Equipped User gains +1 decisive roll in battle involving User"},artifact_coin:{cost:5,dmg:2,hp:2,effect:"Item is treated as 5G"},absorbing_spirit:{cost:5,dmg:2,hp:2,effect:"Equipped User's Ultimate recharge rate is 2"}},legendary_gear:{"wilhelm's_gauntlet":{cost:15,dmg:0,hp:5,limit_class:"guardian",effect:"When the equipped User blocks an attack, deal DMG equal to the equipped User's DMG to the attacking enemy. Can only be equipped by Guardians",spec:3,spec_type:"soul"},"solomon's_cipher":{cost:15,dmg:2,hp:3,limit_class:"spellweaver",effect:"Equipped User can attack and use their abilities in the same turn. Can only be equipped by Spellweavers",spec:3,spec_type:"intelligence"},"zatyr's_saber":{cost:15,dmg:5,hp:0,limit_class:"slayer",effect:"Successful attacks on enemies heal equipped User by 2HP. Can only be equipped by Slayers",spec:3,spec_type:"courage"},"magus'_cloak":{cost:15,dmg:1,hp:4,limit_class:"enchanter",effect:"Equipped User is immune to debuffs. Can only be equipped by Enchanters",spec:3,spec_type:"aura"},"weeper's_satchel":{cost:15,dmg:3,hp:2,limit_class:"trickster",effect:"+1 Item, +XG equal to dice roll, +1 consumable Item slot and +1 succession roll. Can only be equipped by Tricksters",spec:3,spec_type:"luck"}}},getGear:function(e){e=e.split(Select.KEY_DELIMITER);const t=Gear.GEAR[e[0]];if(!t)return;const a=t[e[1]];return a.category=e[0],a.name=e[1],a},getGearKey:function(e){return Select.makeKey(e.category,e.name)}};Gear.$GEAR_SELECT=function(){const e={};for(let t in Gear.GEAR){e[t]={};for(let a in Gear.GEAR[t]){const s=Gear.GEAR[t][a],i=[s.dmg||0,s.hp||0,s.spec?s.spec+" "+s.spec_type:0];e[t][a]=a+" ("+i.join("/")+")"+(s.limit_class?" - "+titleCase(s.limit_class)+" only":"")}}return Select.makeSelect(e,"js-gear-select",!1)}();class Character{static get MAX_LEVEL(){return 3}static get LEVEL_BONUS(){return 2}constructor(e,t=null){this.$node=e,this.$class=Classes.$CLASS_SELECT.clone(),this.$node.find(".js-class").append(this.$class),this.character=null,this.level=0,this.ready=!1,this.$icon=this.$node.find(".js-icon"),this.$title=this.$node.find(".js-title"),this.$debuffs=this.$node.find('.js-debuff input[type="checkbox"]'),this.hp={current:0,base:0,$current:this.$node.find(".js-hp-current"),$value:this.$node.find(".js-hp-max"),$detail:this.$node.find(".js-hp-detail"),$mod:this.$node.find(".js-hp-mod")},this.dmg={base:0,$value:this.$node.find(".js-dmg-value"),$detail:this.$node.find(".js-dmg-detail"),$mod:this.$node.find(".js-dmg-mod")},this.spec={base:1,$name:this.$node.find(".js-spec-name"),$value:this.$node.find(".js-spec-value"),$detail:this.$node.find(".js-spec-detail"),$mod:this.$node.find(".js-spec-mod")},this.recharge={current:0,base:0,$current:this.$node.find(".js-recharge-current"),$value:this.$node.find(".js-recharge-value"),$detail:this.$node.find(".js-recharge-detail"),$mod:this.$node.find(".js-recharge-mod")},this.$ultimate=this.$node.find(".js-ability-ultimate"),this.gear=[],this.$gear=this.$node.find(".js-gear"),this.$gear.each((e,t)=>$(t).prepend(Gear.$GEAR_SELECT.clone().data("slot",e))),t&&this.fromBundle(t)}changeClass(e){this.ready=!0,this.character=Classes.getCharacter(e),this.$node.removeClass(Object.keys(Classes.CLASSES).join(" ")).addClass(this.character.class),this.$icon.attr("src","./public/img/"+this.character.name+".png"),this.$title.html(this.character.title),this.gear=[],this.$gear.find(".js-gear-select").val("-"),this.setAbilities(),this.$node.find(".js-status-mod").val(""),this.$node.find(".js-gear-show-detail, .js-gear-detail").addClass("hidden").removeClass("pressed");for(let e of this.$debuffs)$(e).prop("checked",!1).parent().removeClass("checked");this.hp.current=this.character.hp,this.hp.base=this.character.hp,this.hp.$current.val(this.character.hp),this.mod("hp"),this.dmg.base=this.character.dmg,this.mod("dmg"),this.spec.base=1,this.spec.$name.html(titleCase(this.character.specType)),this.mod("spec"),this.recharge.current=0,this.recharge.base=this.character.abilities.ultimate.recharge,this.hp.$current.val(0),this.mod("recharge"),this.$node.find(".js-character-detail").slideDown()}mod(e){const t=this.getStatusMod(e),a=this[e].base+this.getLevelMod(e),s=Math.max(0,a+t);if(this[e].$value.html(s),0!==t){const s=t>0?" + ":" - ";this[e].$detail.html(a+s+Math.abs(t)),this[e].$detail.parent().addClass("character-status-modified")}else this[e].$detail.html(""),this[e].$detail.parent().removeClass("character-status-modified");-1!==["hp","recharge"].indexOf(e)&&(this[e].current=Math.min(this[e].current,s),this[e].$current.val(this[e].current),"recharge"===e&&(this.recharge.current===s?this.$ultimate.addClass("charged"):this.$ultimate.removeClass("charged")))}setAbilities(){for(let e in this.character.abilities){const t=this.character.abilities[e];this.$node.find(".js-ability-"+e+" .js-ability-name").html(t.name),this.$node.find(".js-ability-"+e+" .js-ability-detail").html(t.effect)}}getLevelMod(e){return-1===["hp","dmg"].indexOf(e)?0:"zuciel"==this.character.name&&"dmg"==e?0:this.level*Character.LEVEL_BONUS}getStatusMod(e){return int(this[e].$mod.val())+this.getGearMod(e)+this.getCharacterMod(e)}getGearMod(e){const t=this.character;return this.gear.reduce(function(a,s){return!s||"spec"===e&&s.spec_type&&s.spec_type!==t.specType||(a+=s[e]||0),a},0)}getCharacterMod(e){switch(this.character.name){case"zuciel":this.$gold=this.$gold||$(".js-gold");const t=int(this.$gold.val());return"dmg"==e?t-this.getGearMod(e):0;case"psykoshka":return"dmg"!==e?0:this.spec.base+this.getStatusMod("spec");default:return 0}}updateCurrent(e){const t=int(this[e].$current.val());this[e].current=t-this.getStatusMod(e),this.mod(e)}updateGear(e,t){const a=Gear.getGear(t),s=a&&(!a.limit_class||this.character.class===a.limit_class);return this.gear[e]=s?a:void 0,this.mod("hp"),this.mod("dmg"),this.mod("spec"),this.mod("recharge"),this.updateGearEffect(this.gear[e],$(this.$gear[e])),s}updateGearEffect(e,t){e&&e.effect?(t.find(".js-gear-show-detail").removeClass("hidden"),t.find(".js-gear-detail").html(e.effect)):(t.find(".js-gear-show-detail, .js-gear-detail").addClass("hidden"),t.find(".js-gear-detail").html(""))}updateLevel(e){this.level=Math.min(Character.MAX_LEVEL,Math.max(0,e)),this.mod("hp"),this.mod("dmg"),this.hp.current=this.hp.base+this.getLevelMod("hp")+this.getStatusMod("hp"),this.hp.$current.val(this.hp.current)}toBundle(){const e={debuffs:this.$debuffs.map((e,t)=>t.checked).toArray(),character_key:Classes.getCharacterKey(this.character),level:this.level,hp:{current:this.hp.current,mod:int(this.hp.$mod.val())},dmg:{mod:int(this.dmg.$mod.val())},spec:{mod:int(this.spec.$mod.val())},recharge:{current:this.recharge.current,mod:int(this.recharge.$mod.val())},gear:[]};for(let t of this.gear)t&&e.gear.push(Gear.getGearKey(t));return e}fromBundle(e){this.changeClass(e.character_key),this.$class.val(e.character_key),this.level=e.level;for(let t in e.gear)this.gear[t]=Gear.getGear(e.gear[t]),$(this.$gear[t]).find(".js-gear-select").val(e.gear[t]),this.updateGearEffect(this.gear[t],$(this.$gear[t]));for(let t of["hp","dmg","spec","recharge"])this[t].$mod.val(int(e[t].mod)),-1!==["hp","recharge"].indexOf(t)&&(this[t].current=e[t].current),this.mod(t);for(let t in e.debuffs)e.debuffs[t]&&$(this.$debuffs[t]).prop("checked",!0).parent().toggleClass("checked")}}$(function(){const e="v0";$(".js-version").html(e);const t=5,a=5e3,s={MESSAGE:"Would you like to save your data locally?",NO:"No, don't!",YES:"Sure"},i={MESSAGE:"Hey, we've updated, so old data will be deleted. Sorry!<br>Do you still want to save your data locally?",NO:"Nah",YES:"Yes please!"},r=$(".js-storage-prompt"),n=$(".js-character-template .js-character"),c=$(".js-key-shards"),l=$(".js-gold"),o=$(".js-main-content"),h=$(".js-add-character");let d=null,u=null;function m(e=null){const t=n.clone();t.data("character",new Character(t,e)),t.insertBefore(h.parent())}function f(){o.find(".js-character").length>=t?h.hide():h.show()}function p(){window.clearTimeout(u),u=window.setTimeout(g,a)}function g(){d[e]={key_shards:int(c.val()),gold:int(l.val()),characters:[]},o.find(".js-character").each(function(t,a){const s=$(a).data("character");s.ready&&d[e].characters.push(s.toBundle())}),localStorage.visseria=JSON.stringify(d)}h.on("click",function(){m(),f()}),r.on("click",".js-prompt-button",function(){"yes"===$(this).data("answer")&&(d={},g()),r.remove()}),$(document).on("change",p),c.on("change",function(){const e=int($(this).val());$(".js-character").each(function(t,a){const s=$(a).data("character");s&&s.ready&&s.updateLevel(e)})}),$(document).on("click",".js-delete-character",function(){$(this).closest(".js-character").remove(),f(),p()}),$(document).on("change",".js-class-select",function(){$(this).closest(".js-character").data("character").changeClass($(this).val()),c.trigger("change")}),$(document).on("change",".js-gear-select",function(){const e=$(this).closest(".js-character").data("character");e.ready&&(e.updateGear($(this).data("slot"),$(this).val())||$(this).val("-"))}),$(document).on("change",".js-status-mod",function(){const e=$(this).closest(".js-character").data("character");e.ready&&e.mod($(this).data("status"))}),$(document).on("change",".js-hp-current, .js-recharge-current",function(){const e=$(this).closest(".js-character").data("character");e.ready&&e.updateCurrent($(this).data("status"))});for(let e of["gear","ability"])$(document).on("click",".js-"+e+"-show-detail",function(){$(this).toggleClass("pressed"),$(this).parent().siblings(".js-"+e+"-detail").toggleClass("hidden")});if($(document).on("click",'.js-debuff input[type="checkbox"]',function(){$(this).parent().toggleClass("checked")}),localStorage.visseria)try{if(d=JSON.parse(localStorage.visseria),Object.keys(d).length>0&&!d[e])throw r.find(".js-prompt-message").html(i.MESSAGE),r.find(".js-prompt-button.no").html(i.NO),r.find(".js-prompt-button.yes").html(i.YES),r.removeClass("hidden"),"App was updated to version: "+e;if(c.val(d[e].key_shards),l.val(d[e].gold),d[e].characters)for(let t of d[e].characters)m(t)}catch(e){console.error("An error occurred while loading from storage:\n"+e),d={}}else r.find(".js-prompt-message").html(s.MESSAGE),r.find(".js-prompt-button.no").html(s.NO),r.find(".js-prompt-button.yes").html(s.YES),r.removeClass("hidden");0===o.find(".js-character").length&&m()});